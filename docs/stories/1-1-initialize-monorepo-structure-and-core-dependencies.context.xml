<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Initialize Monorepo Structure and Core Dependencies</title>
    <status>drafted</status>
    <generatedAt>2025-11-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-1-initialize-monorepo-structure-and-core-dependencies.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a properly structured monorepo with backend, frontend, and shared packages with all core dependencies installed</iWant>
    <soThat>the team can work efficiently with proper tooling, dependency management, and can start both development servers successfully</soThat>
    <tasks>
      - Task 1: Initialize Monorepo Root (AC: #1)
      - Task 2: Initialize Frontend Package (AC: #1, #2)
      - Task 3: Initialize Backend Package (AC: #1, #2)
      - Task 4: Initialize Shared Package (AC: #1)
      - Task 5: Set Up Infrastructure (AC: #1, #3)
      - Task 6: Configure Development Environment (AC: #4)
      - Task 7: Implement Health Check Endpoint (AC: #3)
      - Task 8: Testing (All ACs)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Monorepo Structure Created</title>
      <description>Given I am setting up a new development environment, when I run the initialization commands, then the monorepo structure is created with: packages/frontend/ (Next.js 15 + TypeScript + Tailwind), packages/backend/ (FastAPI + Poetry + async SQLAlchemy), packages/shared/ (TypeScript types), Docker Compose for local Redis, root package.json with pnpm workspace configuration</description>
      <source>docs/epics/epic-1-user-onboarding-foundation.md#Story-1.1, docs/tech-spec-epic-1.md#AC1</source>
    </criterion>
    <criterion id="AC2">
      <title>Core Dependencies Installed</title>
      <description>All core dependencies are present: Frontend (Next.js 15, React 19, TypeScript, Tailwind, shadcn/ui, @clerk/nextjs, framer-motion), Backend (FastAPI, SQLAlchemy 2.0 async, asyncpg, Pydantic, Alembic, clerk-backend-sdk, redis, arq, sentry-sdk), AI/ML (LangChain, LangGraph, langchain-postgres, pgvector, transformers, torch)</description>
      <source>docs/tech-spec-epic-1.md#AC2, docs/tech-spec-epic-1.md#Dependencies</source>
    </criterion>
    <criterion id="AC3">
      <title>Development Servers Start Successfully</title>
      <description>Frontend starts successfully: pnpm dev (http://localhost:3000), Backend starts successfully: poetry run uvicorn main:app --reload (http://localhost:8000), Supabase PostgreSQL is accessible, Redis is accessible (Upstash or Docker), Health check endpoint responds: GET http://localhost:8000/api/v1/health</description>
      <source>docs/tech-spec-epic-1.md#AC1, docs/tech-spec-epic-1.md#AC6</source>
    </criterion>
    <criterion id="AC4">
      <title>Environment Configuration Complete</title>
      <description>.env.example files exist for both frontend and backend with required environment variables documented: DATABASE_URL (Supabase), REDIS_URL, CLERK_PUBLISHABLE_KEY (frontend), CLERK_SECRET_KEY (backend), OPENAI_API_KEY, SENTRY_DSN. .env files are in .gitignore, README.md contains setup instructions</description>
      <source>docs/tech-spec-epic-1.md#AC6, docs/architecture/project-structure.md</source>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification: User Onboarding & Foundation</title>
        <section>Overview, Technology Stack Decisions, Dependencies</section>
        <snippet>Comprehensive technical specification for Epic 1 covering monorepo setup, technology stack (Next.js 15, FastAPI, Supabase PostgreSQL, Clerk auth), all dependencies, and infrastructure constraints (cost target &lt;$0.50 per user per day).</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-1-user-onboarding-foundation.md</path>
        <title>Epic 1: User Onboarding & Foundation</title>
        <section>Story 1.1: Initialize Monorepo Structure and Core Dependencies</section>
        <snippet>Story requirements with acceptance criteria for monorepo initialization, core dependencies installation (Next.js 15, FastAPI, Clerk, AI/ML stack), development server startup, and environment configuration.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/project-structure.md</path>
        <title>Project Structure</title>
        <section>Complete monorepo directory structure</section>
        <snippet>Canonical directory structure for frontend (App Router with route groups: (auth)/, (world)/, companion/, missions/, progress/), backend (api/v1/, core/, models/, schemas/, services/, agents/, workers/, db/), and shared packages (TypeScript types).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/technology-stack-details.md</path>
        <title>Technology Stack Details</title>
        <section>Frontend, Backend, Database, Authentication</section>
        <snippet>Detailed technology choices: Frontend (Next.js 15 App Router, React 19, TypeScript, Tailwind, shadcn/ui), Backend (FastAPI, async SQLAlchemy 2.0, asyncpg), Database (Supabase managed PostgreSQL with pgvector), Authentication (Clerk managed service), Infrastructure (ARQ + Redis for job queue, Sentry for observability).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/development-environment.md</path>
        <title>Development Environment</title>
        <section>Prerequisites, Setup Commands</section>
        <snippet>Prerequisites: Node.js 20+, Python 3.11+, Poetry, Supabase account, optional Docker for Redis. Setup includes pnpm workspace initialization, Poetry backend setup, Supabase configuration, and environment variable management.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/api-contracts.md</path>
        <title>API Contracts</title>
        <section>Health Check Endpoints</section>
        <snippet>Health check endpoint specification: GET /api/v1/health returns JSON with status (healthy/degraded/unhealthy), database connection status, redis connection status, and timestamp. No authentication required.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/implementation-patterns.md</path>
        <title>Implementation Patterns</title>
        <section>Monorepo Organization, Dependency Management</section>
        <snippet>Patterns for pnpm workspaces, Poetry dependency isolation, shared type definitions, environment configuration (.env.example templates), and development workflow (parallel frontend/backend development with health checks).</snippet>
      </doc>
      <doc>
        <path>docs/product-brief-Delight-2025-11-09.md</path>
        <title>Product Brief: Delight</title>
        <section>Vision, Core Features</section>
        <snippet>Delight is a self-improvement companion platform pairing emotionally intelligent AI coaching with structured progress systems. Vision: software that feels seamlessly supportive and ruthlessly effective. Foundation epic establishes technical infrastructure for companion chat, mission management, and narrative systems.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>docker-compose.yml</path>
        <kind>infrastructure</kind>
        <symbol>docker-compose</symbol>
        <lines>1-10</lines>
        <reason>Existing Docker Compose configuration - needs updating to include only Redis (Supabase replaces PostgreSQL). Provides infrastructure service definitions for local development.</reason>
      </artifact>
      <artifact>
        <path>README.md</path>
        <kind>documentation</kind>
        <symbol>README</symbol>
        <lines>1-555</lines>
        <reason>Existing project README - needs updating with monorepo setup instructions, Supabase configuration, Clerk setup, and development server startup commands. Will serve as primary developer onboarding document.</reason>
      </artifact>
      <artifact>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>package.json</symbol>
        <lines>empty</lines>
        <reason>Root package.json needs to be created with pnpm workspace configuration pointing to packages/* for monorepo management. Will coordinate frontend and shared package dependencies.</reason>
      </artifact>
    </code>
    <dependencies>
      <frontend>
        <package name="next" version="^15.0.0" />
        <package name="react" version="^19.0.0" />
        <package name="react-dom" version="^19.0.0" />
        <package name="@clerk/nextjs" version="^5.0.0" />
        <package name="typescript" version="^5.3.0" />
        <package name="tailwindcss" version="^3.4.0" />
        <package name="framer-motion" version="^11.0.0" />
        <package name="@radix-ui/react-*" version="latest" />
        <package name="class-variance-authority" version="^0.7.0" />
        <package name="clsx" version="^2.1.0" />
        <package name="tailwind-merge" version="^2.2.0" />
        <package name="eslint" version="^8.56.0" />
        <package name="prettier" version="^3.2.0" />
      </frontend>
      <backend>
        <package name="fastapi" version="^0.109.0" />
        <package name="uvicorn[standard]" version="^0.27.0" />
        <package name="sqlalchemy[asyncio]" version="^2.0.25" />
        <package name="asyncpg" version="^0.29.0" />
        <package name="alembic" version="^1.13.0" />
        <package name="pydantic" version="^2.5.0" />
        <package name="pydantic-settings" version="^2.1.0" />
        <package name="clerk-backend-sdk" version="^0.3.0" />
        <package name="redis" version="^5.0.1" />
        <package name="arq" version="^0.26.0" />
        <package name="sentry-sdk[fastapi]" version="^1.40.0" />
        <package name="langchain" version="^0.1.0" />
        <package name="langgraph" version="^0.0.20" />
        <package name="langchain-postgres" version="^0.0.3" />
        <package name="pgvector" version="^0.2.4" />
        <package name="transformers" version="^4.36.0" />
        <package name="torch" version="^2.1.0" />
        <package name="pytest" version="^7.4.0" group="dev" />
        <package name="pytest-asyncio" version="^0.23.0" group="dev" />
        <package name="httpx" version="^0.26.0" group="dev" />
        <package name="ruff" version="^0.1.11" group="dev" />
        <package name="black" version="^23.12.0" group="dev" />
        <package name="mypy" version="^1.8.0" group="dev" />
      </backend>
      <infrastructure>
        <service name="Supabase" purpose="Managed PostgreSQL 16+ with pgvector" tier="free (500MB)" />
        <service name="Upstash" purpose="Managed Redis (optional, alternative to Docker)" tier="free" />
        <service name="Clerk" purpose="Authentication service with OAuth providers" tier="free (10,000 MAU)" />
        <service name="Sentry" purpose="Error tracking and monitoring" tier="free (5,000 errors/month)" />
      </infrastructure>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <rule>Use Supabase (managed PostgreSQL) instead of local Docker PostgreSQL - pgvector extension pre-installed, free tier 500MB, production-ready from day one</rule>
      <source>docs/tech-spec-epic-1.md#Technology-Stack-Decisions</source>
    </constraint>
    <constraint type="architecture">
      <rule>Monorepo structure: pnpm workspaces for frontend/shared (Node.js), Poetry for backend (Python) - do NOT mix package managers</rule>
      <source>docs/tech-spec-epic-1.md#Infrastructure-Constraints, docs/architecture/project-structure.md</source>
    </constraint>
    <constraint type="architecture">
      <rule>Frontend: Next.js 15 App Router with React Server Components, organized by route groups: (auth)/, (world)/, companion/, missions/, progress/</rule>
      <source>docs/architecture/project-structure.md</source>
    </constraint>
    <constraint type="architecture">
      <rule>Backend: FastAPI with async SQLAlchemy 2.0, organized by layers: api/v1/ (routes), core/ (config), models/ (database), services/ (business logic), agents/ (LangGraph), workers/ (ARQ jobs)</rule>
      <source>docs/architecture/project-structure.md</source>
    </constraint>
    <constraint type="security">
      <rule>NEVER commit .env files - use .env.example templates only. Add .env to .gitignore. Document all required environment variables with examples.</rule>
      <source>docs/tech-spec-epic-1.md#Security</source>
    </constraint>
    <constraint type="security">
      <rule>Authentication handled by Clerk - install dependencies now (@clerk/nextjs, clerk-backend-sdk) but full integration deferred to Story 1.3</rule>
      <source>docs/tech-spec-epic-1.md#Story-1.3</source>
    </constraint>
    <constraint type="performance">
      <rule>Cost target: &lt;$0.50 per active user per day - guides choice of managed services (Supabase free tier, Clerk free tier, Upstash free tier)</rule>
      <source>docs/tech-spec-epic-1.md#Infrastructure-Constraints</source>
    </constraint>
    <constraint type="performance">
      <rule>API Response Time target (p95): &lt;500ms - use async SQLAlchemy, connection pooling, efficient queries</rule>
      <source>docs/tech-spec-epic-1.md#Performance</source>
    </constraint>
    <constraint type="testing">
      <rule>Testing strategy for Story 1.1: Focus on integration testing (services start successfully), verify health check endpoint, verify linters run without errors, verify builds complete</rule>
      <source>docs/stories/1-1-initialize-monorepo-structure-and-core-dependencies.md#Testing-Strategy</source>
    </constraint>
    <constraint type="dependency">
      <rule>AI/ML dependencies installed in Story 1.1 for future use: LangChain/LangGraph (Epic 2: companion agent), transformers/torch (Story 2.6: emotion detection), langchain-postgres/pgvector (Epic 2: memory system)</rule>
      <source>docs/tech-spec-epic-1.md#AI/LLM-Infrastructure</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Health Check Endpoint</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/health â†’ { status: "healthy" | "degraded" | "unhealthy", database: "connected" | "disconnected", redis: "connected" | "disconnected", timestamp: ISO8601 }</signature>
      <path>packages/backend/app/api/v1/health.py</path>
      <description>Public endpoint (no auth required) for monitoring system health. Checks database and Redis connectivity. Returns 200 OK with status details.</description>
    </interface>
    <interface>
      <name>Shared TypeScript Types</name>
      <kind>TypeScript barrel export</kind>
      <signature>export type User = { id: string; clerk_user_id: string; email: string; timezone: string; created_at: string; updated_at: string; }</signature>
      <path>packages/shared/index.ts</path>
      <description>Shared type definitions re-exported through barrel file for clean imports in frontend. Initial types: User, UserPreferences (Story 1.2 will add more).</description>
    </interface>
    <interface>
      <name>FastAPI Application Entry</name>
      <kind>Application initialization</kind>
      <signature>from fastapi import FastAPI; app = FastAPI(title="Delight API", version="0.1.0"); app.include_router(health_router, prefix="/api/v1")</signature>
      <path>packages/backend/main.py</path>
      <description>Main FastAPI application with CORS middleware, health check route registration, and future route inclusions (auth, missions, companion, etc.)</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing for Story 1.1 focuses on integration and smoke testing to verify infrastructure setup. Frontend: ESLint for linting, future Jest + React Testing Library for unit tests, future Playwright for E2E. Backend: Ruff + Black for linting, pytest for unit/integration tests (70%+ coverage target for core logic). Health check endpoint must return 200 OK with correct JSON structure. All services (frontend, backend, Supabase, Redis) must start without errors. Build commands (pnpm build, poetry install) must complete successfully.
    </standards>
    <locations>
      - packages/frontend/__tests__/ (Jest unit tests - future)
      - packages/frontend/e2e/ (Playwright E2E tests - future)
      - packages/backend/tests/ (pytest tests)
      - packages/backend/tests/integration/ (integration tests - future)
    </locations>
    <ideas>
      <idea ac="AC1">
        Test: Run pnpm install in root, verify packages/frontend/, packages/backend/, packages/shared/ directories exist with correct structure
      </idea>
      <idea ac="AC2">
        Test: Run poetry show in backend, verify all required packages (fastapi, sqlalchemy, clerk-backend-sdk, langchain, transformers) are installed with correct versions
      </idea>
      <idea ac="AC2">
        Test: Run pnpm list in frontend, verify all required packages (next, react, @clerk/nextjs, tailwindcss) are installed
      </idea>
      <idea ac="AC3">
        Test: Start frontend dev server (pnpm dev), verify server responds at http://localhost:3000 with Next.js default page
      </idea>
      <idea ac="AC3">
        Test: Start backend dev server (poetry run uvicorn main:app --reload), verify server responds at http://localhost:8000
      </idea>
      <idea ac="AC3">
        Test: Curl health check endpoint: curl http://localhost:8000/api/v1/health, verify 200 OK response with JSON structure { status, database, redis, timestamp }
      </idea>
      <idea ac="AC3">
        Test: Verify Supabase DATABASE_URL connection string works - backend can connect to Supabase PostgreSQL successfully
      </idea>
      <idea ac="AC3">
        Test: Verify Redis connection (Upstash or Docker) - backend can connect to Redis successfully
      </idea>
      <idea ac="AC4">
        Test: Verify .env.example files exist in packages/frontend/ and packages/backend/ with all required variables documented
      </idea>
      <idea ac="AC4">
        Test: Verify .env is in .gitignore - run git check-ignore .env, should return exit code 0
      </idea>
      <idea ac="AC4">
        Test: Verify README.md contains setup instructions with Supabase configuration, Clerk setup, and development server commands
      </idea>
      <idea ac="ALL">
        Test: Run linters - frontend: pnpm lint (ESLint), backend: poetry run ruff check . and poetry run black --check . - all should pass
      </idea>
      <idea ac="ALL">
        Test: Run build commands - frontend: pnpm build, backend: poetry install - both should complete without errors
      </idea>
    </ideas>
  </tests>
</story-context>

